name: Build and Publish

on:
  push:
    branches: ['master']

jobs:
  py_build:
    name: Build Python package
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.package_meta.outputs.package_name }}
      base_version: ${{ steps.package_meta.outputs.base_version }}
      release_version: ${{ steps.package_meta.outputs.release_version }}
      tag_name: ${{ steps.package_meta.outputs.tag_name }}
      commits_since_tag: ${{ steps.package_meta.outputs.commits_since_tag }}
      is_prerelease: ${{ steps.package_meta.outputs.is_prerelease }}

    steps:
      # Fetch full git repository and all submodules
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # Checkout tags
      - name: Fetch tags
        run: |
          git fetch --prune --unshallow --tags
          echo exit code $?
          git tag --list

      # Setup python environment
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Install uv
      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 #v7.1.4

      # Determine release metadata from pyproject/git state
      - name: Determine package version metadata
        id: package_meta
        run: |
          set -euo pipefail
          PACKAGE_INFO=$(uv version)
          PACKAGE_NAME=$(echo "${PACKAGE_INFO}" | awk '{print $1}')
          BASE_VERSION=$(uv version --short)
          TAG_NAME="${BASE_VERSION}"
          TAG_EXISTS=false
          COMMITS_SINCE_TAG=0
          HAS_COMMITS=false
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            HAS_COMMITS=true
          fi
          if [ "${HAS_COMMITS}" = "true" ] && git rev-parse "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
            TAG_EXISTS=true
            COMMITS_SINCE_TAG=$(git rev-list "refs/tags/${TAG_NAME}..HEAD" --count)
          fi
          RELEASE_VERSION="${BASE_VERSION}"
          IS_PRERELEASE=false
          if [ "${TAG_EXISTS}" = "true" ] && [ "${COMMITS_SINCE_TAG}" -gt 0 ]; then
            RELEASE_VERSION="${BASE_VERSION}.post${COMMITS_SINCE_TAG}"
            IS_PRERELEASE=true
          fi
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "commits_since_tag=${COMMITS_SINCE_TAG}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT

      # Align pyproject version with derived release version
      - name: Update pyproject version for release
        if: steps.package_meta.outputs.release_version != steps.package_meta.outputs.base_version
        run: |
          uv version "${{ steps.package_meta.outputs.release_version }}"

      # Build python dist package
      - name: Build python dist package
        id: build_py
        run: |
          PY_VERSION="${{ steps.package_meta.outputs.release_version }}"
          echo "Version from pyproject.toml: ${PY_VERSION}"
          REPO_URL="https://github.com/${GITHUB_REPOSITORY}/raw/${GITHUB_REF#refs/heads}/"
          sed -i "s|(./docs/|(${REPO_URL:?}/docs/|g" README.md
          uv build

      # Read the python package distribution data (save version to file)
      - name: Read python package distribution data
        id: py_build_data
        run: |
          PY_VERSION="${{ steps.package_meta.outputs.release_version }}"
          PY_BDIST_PATH=$(ls  dist/*.whl | head -n1)
          PY_BDIST_FILE=${PY_BDIST_PATH#*/}
          echo "py_version=${PY_VERSION}" >> $GITHUB_OUTPUT
          echo "py_bdist_file=${PY_BDIST_FILE}" >> $GITHUB_OUTPUT
          echo "py_bdist_path=${PY_BDIST_PATH}" >> $GITHUB_OUTPUT
          echo ${PY_VERSION} > dist/VERSION.txt

      # Upload python package distribution data artifact
      - uses: actions/upload-artifact@v4
        with:
          name: secrets-sync-py-dist-data-${{ steps.py_build_data.outputs.py_version }}
          path: dist/

  publish_pypi:
    name: Publish package to PyPI
    needs: py_build
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      id-token: write
      contents: write
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    steps:
      # Fetch shallow git repository
      - name: Checkout
        uses: actions/checkout@v4

      # Fetch all artifacts
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/

      # Restore python package distribution data
      - name: Restore python package distribution data
        id: py_build_data
        run: |
          mkdir -p ./dist
          find ./artifacts/ -type f -name "*.whl" -exec cp -n {} ./dist/ \;
          find ./artifacts/ -type f -name "*.tar.gz" -exec cp -n {} ./dist/ \;
          ls -l ./dist/

      # Bundle files for GitHub releases
      - name: Create release output directory
        env:
          PACKAGE_NAME: ${{ needs.py_build.outputs.package_name }}
          RELEASE_VERSION: ${{ needs.py_build.outputs.release_version }}
        run: |
          set -euo pipefail
          rm -rf ./out
          RELEASE_DIR="./out/${PACKAGE_NAME}-${RELEASE_VERSION}"
          mkdir -p "${RELEASE_DIR}"
          cp README.md "${RELEASE_DIR}/"
          cp LICENSE "${RELEASE_DIR}/"
          cp pyproject.toml "${RELEASE_DIR}/"
          cp -rf dist "${RELEASE_DIR}/dist"

      - name: Archive release bundle
        env:
          PACKAGE_NAME: ${{ needs.py_build.outputs.package_name }}
          RELEASE_VERSION: ${{ needs.py_build.outputs.release_version }}
        run: |
          set -euo pipefail
          cd out
          zip -r "${PACKAGE_NAME}-${RELEASE_VERSION}.zip" "${PACKAGE_NAME}-${RELEASE_VERSION}"
          tar -czvf "${PACKAGE_NAME}-${RELEASE_VERSION}.tar.gz" "${PACKAGE_NAME}-${RELEASE_VERSION}"

      - name: Upload release bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}-bundle
          path: |
            ./out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}/*
            ./out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}.zip
            ./out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}.tar.gz

      - name: Check tag already exists
        uses: mukunku/tag-exists-action@bdad1eaa119ce71b150b952c97351c75025c06a9 #v1.6.0
        id: check_tag_exists
        with:
          tag: ${{ needs.py_build.outputs.base_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate tagged release
        uses: ncipollo/release-action@440c8c1cb0ed28b9f43e4d1d670870f059653174 #v1.16.0
        if: needs.py_build.outputs.is_prerelease == 'false' && steps.check_tag_exists.outputs.exists == 'false'
        with:
          name: 'Tagged Build: ${{ needs.py_build.outputs.base_version }}'
          body: 'Versioned release'
          # TODO: Replace with GITHUB_TOKEN when this is fixed -> https://github.com/orgs/community/discussions/180355
          token: ${{ secrets.GH_TOKEN }}
          artifacts: './out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}.zip,./out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}.tar.gz'
          generateReleaseNotes: true
          allowUpdates: false
          skipIfReleaseExists: true
          tag: ${{ needs.py_build.outputs.base_version }}
          commit: ${{ github.sha }}

      - name: Update latest development release
        uses: ncipollo/release-action@440c8c1cb0ed28b9f43e4d1d670870f059653174 #v1.16.0
        with:
          name: 'Development Build'
          body: 'Latest development release'
          # TODO: Replace with GITHUB_TOKEN when this is fixed -> https://github.com/orgs/community/discussions/180355
          token: ${{ secrets.GH_TOKEN }}
          artifacts: './out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}.zip,./out/${{ needs.py_build.outputs.package_name }}-${{ needs.py_build.outputs.release_version }}.tar.gz'
          generateReleaseNotes: true
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          tag: latest
          commit: ${{ github.sha }}
          prerelease: true

      # Install uv for publishing
      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 #v7.1.4

      # Push the artifacts to PyPI repo
      - name: Publish distribution package to PyPI
        run: |
          ls -l dist/
          uv publish dist/*
